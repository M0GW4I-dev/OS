# メモリーマップ
0x00000000  ┌──────────────────
            │割り込みベクタテーブル
0x00000400  ├──────────────────
            │BIOSデータ
0x00000500  ├──────────────────
            │未使用
0x00007c00  ├──────────────────
            │ブートローダ
0x00007e00  ├──────────────────
            │未使用
0x000A0000  ├──────────────────
            │VRAM(ビデオメモリ)
0x000B0000  ├──────────────────
            │VRAM(モノクロ)
0x000B8000  ├──────────────────
            │VRAM(カラー)
0x000C0000  ├──────────────────
            │BIOS Video関連
0x000F0000  ├──────────────────
            │BIOS 予備
0x00100000  ├──────────────────
            │BIOS
0x00000000  └──────────────────

# protected mode
* 保護モード
* 32 bit で動作
* 仮想メモリ
* メモリの扱いの変更
* 4 GBまで使用可能
* BIOSの処理が使用不可

# メモリアクセスについて
セグメントレジスタとGDTを用いてメモリアクセス
それぞれのセグメントレジスタはセグメントディスクリプタを表すGDTが始まるアドレスからのオフセットが入る

## GDT
┌────────────────────────────────────
│Segment Discriptor(64 bit)
├────────────────────────────────────
│...
├────────────────────────────────────

## 論理アドレスとリニアアドレス
論理アドレスは、[セグメントセレクタの値:オフセット]になる
実アドレスは、セグメントセレクタの値で指定されたセグメントディスクリプタのbaseaddressに加算したもの
プログラム中に明示的にセグメントレジスタを指定しなければ、DSかSSレジスタを使う

## 特権レベル
リング0 ~ リング3 がある
リング0 は、特権レベルが高い
リング3 は、特権レベルが低い

## セグメントセレクタ
[セグメントセレクタ:オフセット]で論理アドレスを指定した時、セグメントセレクタは
セグメントセレクタは3~15bit目がセグメントディスクリプタを表すindexで、2bit目は、テーブルインジケータ、0~1bit目は、RPL(Requested Privilege Level)を表す。

# プロテクテッドモードへの移行
32bit のCR0レジスタのPEbitを 1 にする
protected mode に移動した直後に、

```
movl $0x08, %cs
movl $0x10, %ds
```

は動作しない。

# Grub
## カーネル移行時のマシン状態
* %eax: マジックナンバー 0x2badb002 を格納
* %ebx: マルチブート情報を格納しているアドレス
* %cs: この時点で、既にGDTは構築済みで、コードセグメントを洗濯した状態になっている
* %DS, %ES, %Fs, %GS, %SS: ローダが構築したデータセグメントになっている
* A20ゲート: 既に有効になっている
* CR0: ページングは無効で、protected mode に移行済み
* その他: 未定義

## マルチブート情報
GrubがBIOSから取得したメモリーマップの情報をカーネルに渡してくれる
構造体の内容(かっこ内はflagsの何ビット目に依存しているか

offset(byte)
0   ┌──────────────────
    │flags(必須)
4   ├──────────────────
    │mem_lower(flags(0))
8   ├──────────────────
    │mem_upper(flags(0))
12  ├──────────────────
    │boot_device(flags(1))
16  ├──────────────────
    │cmdline(flags(2))
20  ├──────────────────
    │mods_count(flags(3))
24  ├──────────────────
    │mods_addr(flags(3))
28  ├──────────────────
    │...
40  ├──────────────────
    │syms(flags(4) or flags(5))
44  ├──────────────────
    │mmap_length(flags(6))
48  ├──────────────────
    │mmap_addr(flags(6))
52  ├──────────────────
    │drives_length(flags(7))
56  ├──────────────────
    │drives_addr(flags(7))
60  ├──────────────────
    │config_table(flags(8))
64  ├──────────────────
    │boot_loader_name(flags(9))
68  ├──────────────────
    │apm_table(flags(10))
72  ├──────────────────
    │vbe_control_info(flags(11))
76  ├──────────────────
    │vbe_control_info(flags(11))
80  ├──────────────────
    │vbe_mode_info
82  ├──────────────────
    │vbe_mode
84  ├──────────────────
    │vbe_interface_seg
86  ├──────────────────
    │vbe_interface_off
86  ├──────────────────
    │vbe_interface_len
    └──────────────────
